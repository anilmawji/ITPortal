@page "/create-job"
@page "/create-job/{Id:int}"

@using ITPortal.Lib.Utils;
@using Microsoft.AspNetCore.Authorization;

@*@attribute [Authorize]*@

@inject IScriptOutputStreamService PowerShellService
@inject IScriptJobService ScriptJobService
@inject NavigationManager NavigationManager

<PageContainer Title="PowerShell Jobs" NestedTitle="@_headerTitle" PreviousPage="/jobs">
    <MudForm @ref="_jobForm" @bind-IsValid="@_canSaveJob" @bind-Errors="@_errors">
        <PageSection Title="Script">
            <div class="choose-file-container">
                <MudButton @onclick="PickAndLoadScript" Variant="Variant.Filled" Size="Size.Small">
                    <MudText>Choose File</MudText>
                </MudButton>
                @if (_job.Script.IsLoaded())
                {
                    <span class="file-label">
                        @_job.Script.FileName
                    </span>
                }
                else if (_job.Script.IsUnloaded())
                {
                    <span class="file-label">
                        No file selected
                    </span>
                }
            </div>
            @if (_job.Script.IsLoaded())
            {
                <p class="scroll script-content">
                    @foreach (string line in _job.Script.Content)
                    {
                        @line
                        <br>
                    }
                </p>
                <MudGrid Spacing="2">
                    <MudItem>
                        <MudButton @onclick="EditScript" Variant="Variant.Filled" Color="Color.Secondary" Style="color:white">
                            <MudText>Edit</MudText>
                        </MudButton>
                    </MudItem>
                    <MudItem>
                        <MudButton @onclick="RefreshScript" Variant="Variant.Filled" Color="Color.Secondary" Style="color:white">
                            <MudText>Refresh</MudText>
                        </MudButton>
                    </MudItem>
                    <MudItem>
                        <MudButton @onclick="RemoveScript" Variant="Variant.Filled" Color="Color.Secondary" Style="color:white">
                            <MudText>Remove</MudText>
                        </MudButton>
                    </MudItem>
                </MudGrid>
            }
            else if (_job.Script.LoadFailed())
            {
                <p>Script failed to load</p>
            }
        </PageSection>

        @if (_job.Script.IsLoaded())
        {
            <PageSection Title="Parameters">
                <div class="input-group">
                    @if (_job.Script.Parameters.Count() > 0)
                    {
                        @foreach (ScriptParameter parameter in _job.Script.Parameters)
                        {
                            string requiredError = "The " + parameter.Name + " field is required.";

                            // Cannot use two-way binding for these since parameter.Value is an object and must be casted to the correct type
                            @if (parameter.DesiredType == typeof(string))
                            {
                                // Provide a larger input field depending on the parameter name
                                int numLines = 1;
                                foreach (string trigger in _extendedInputFieldTriggers)
                                {
                                    if (parameter.Name.Equals(trigger, StringComparison.OrdinalIgnoreCase))
                                    {
                                        numLines = 10;
                                        break;
                                    }
                                }
                                <div class="input-line">
                                    <MudTextField T="string" Label="@parameter.Name" Lines="@numLines" Variant="Variant.Filled" Margin="Margin.Dense"
                                        Required="@parameter.Mandatory" Text="@((string)parameter.Value)" TextChanged="(text) => parameter.Value = text"
                                        RequiredError="@requiredError" />
                                </div>
                            }
                            else if (parameter.DesiredType == typeof(int))
                            {
                                <div class="small-input-line">
                                    <MudNumericField T="int" Label="@parameter.Name" Variant="Variant.Filled" Margin="Margin.Dense" Required="@parameter.Mandatory"
                                        Value="@((int)parameter.Value)" ValueChanged="(num) => parameter.Value = num" RequiredError="@requiredError" />
                                </div>
                            }
                            else if (parameter.DesiredType == typeof(bool))
                            {
                                <div class="small-input-line">
                                    <MudSwitch T="bool" Label="@parameter.Name" Required="@parameter.Mandatory" Color="Color.Secondary"
                                        Checked="@((bool)parameter.Value)" CheckedChanged="(checkedValue) => parameter.Value = checkedValue" RequiredError="@requiredError" />
                                </div>
                            }
                            else if (parameter.DesiredType == typeof(DateTime))
                            {
                                // No need to explicitly update "date" since it references parameter.Value which is being updated every time the date changes
                                DateTime date = (DateTime)parameter.Value;
                                TimeSpan time = date.TimeOfDay;

                                <div class="small-input-line mud-date">
                                    <MudDatePicker Label="@parameter.Name" Variant="Variant.Filled" Margin="Margin.Dense" Required="@parameter.Mandatory"
                                        PickerVariant="PickerVariant.Inline" Date="@date" DateChanged="(newDate) => OnDateChanged((DateTime)newDate, time, parameter)"
                                        RequiredError="@requiredError" />
                                    <MudTimePicker Label="@parameter.Name" Variant="Variant.Filled" Margin="Margin.Dense" AmPm="true" Time="@time"
                                        TimeChanged="(newTime) => time = OnTimeChanged((TimeSpan)newTime, date, parameter)" RequiredError="@requiredError" />
                                </div>
                            }
                            else if (parameter.DesiredType == typeof(string[]))
                            {
                                <div class="input-line">
                                    <MudExtensions.MudChipField T="string" Label="@parameter.Name" Margin="Margin.Dense" Required="@parameter.Mandatory"
                                                                Values="@((List<string>)parameter.Value)" Delimiter="_delimiter" FullWidth="true" ChipColor="Color.Default"
                                                                ChipVariant="Variant.Text" ChipSize="Size.Medium" WrapChips="true" ChipsMaxWidth="_chipsMaxWidth" Closeable="true"
                                                                Variant="Variant.Filled" RequiredError="@requiredError" />
                                </div>
                            }
                            else if (parameter.DesiredType == typeof(int[]))
                            {
                                <div class="input-line">
                                    <MudExtensions.MudChipField T="int" Label="@parameter.Name" Margin="Margin.Dense" Required="@parameter.Mandatory"
                                                                Values="@((List<string>)parameter.Value)" Delimiter="_delimiter" FullWidth="true" ChipColor="Color.Default"
                                                                ChipVariant="Variant.Text" ChipSize="Size.Medium" WrapChips="true" ChipsMaxWidth="_chipsMaxWidth" Closeable="true"
                                        Variant="Variant.Filled" RequiredError="@requiredError" />
                                </div>
                            }
                            else if (parameter.DesiredType == typeof(bool[]))
                            {
                                <div class="input-line">
                                    <MudExtensions.MudChipField T="bool" Label="@parameter.Name" Margin="Margin.Dense" Required="@parameter.Mandatory"
                                                                Values="@((List<string>)parameter.Value)" Delimiter="_delimiter" FullWidth="true" ChipColor="Color.Default"
                                                                ChipVariant="Variant.Text" ChipSize="Size.Medium" WrapChips="true" ChipsMaxWidth="_chipsMaxWidth" Closeable="true"
                                        Variant="Variant.Filled" RequiredError="@requiredError" />
                                </div>
                            }
                            else
                            {
                                <p>Parameter @parameter.Name is not supported</p>
                            }
                        }
                    }
                    else
                    {
                        <p>This script does not accept any parameters</p>
                    }
                </div>
            </PageSection>
        }

        <PageSection Title="Schedule">
                <div class="input-line">
                    <MudCheckBox @bind-Checked="@_runNow" Color="Color.Secondary">Run Now</MudCheckBox>
                </div>
                @if (!_runNow)
                {
                    TimeSpan time = _runDate.TimeOfDay;

                    <div class="small-input-line mud-date">
                        <MudDatePicker Label="Run Date" Variant="Variant.Filled" Margin="Margin.Dense" Required="true"
                                       PickerVariant="PickerVariant.Inline" Date="@_runDate" DateChanged="(newDate) => {
                                        _runDate = ((DateTime)newDate).Date.Add(time);
}"
                                       RequiredError="The Run Date field is required." />
                    <MudTimePicker Label="Run Time" Variant="Variant.Filled" Margin="Margin.Dense" AmPm="true" Time="time"
                                       TimeChanged="(newTime) => {
time = (TimeSpan)newTime;
_runDate = _runDate.Date.Add((TimeSpan)newTime);
}" RequiredError="The Run Time field is required." />
                    </div>
                }
        </PageSection>

        <PageSection>
            <div class="input-group job-details">
                <div class="input-line">
                    <MudSelect T="string" @bind-Value="_job.DeviceName" Label="Device" Variant="Variant.Filled" Margin="Margin.Dense" Required="true">
                        <MudSelectItem Value=@_localhostDevice RequiredError="Device name field is required." />
                    </MudSelect>
                </div>
                <div class="input-line">
                    <MudCheckBox @bind-Checked="@_shouldViewJob" Color="Color.Secondary">View Job</MudCheckBox>
                </div>
            </div>
            <div class="create-job-buttons">
                <MudGrid Spacing="2">
                    <MudItem>
                        <MudButton @onclick="GoToJobs" Variant="Variant.Filled" Color="Color.Secondary" Style="color:white">
                            <MudText>Cancel</MudText>
                        </MudButton>
                    </MudItem>
                    <MudItem>
                        <MudButton @onclick="TrySaveJob" Variant="Variant.Filled" Color="Color.Secondary" Style="color:white" Disabled="!_job.Script.IsLoaded()">
                            <MudText>Done</MudText>
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </div>
            <ErrorList Errors="@_errors" />
        </PageSection>
    </MudForm>
</PageContainer>

@code {
    [Parameter]
    public int? Id { get; set; }

    private readonly char _delimiter = ' ';
    private readonly int _chipsMaxWidth = 80;

    private MudForm _jobForm;
    private DateTime _runDate;
    private string[] _errors = { }; 
    private static readonly string[] _extendedInputFieldTriggers = { "body", "description", "message" };

    private FilePickerFileType _allowedFileTypes;
    private PickOptions _filePickOptions;
    private ScriptJob _job;

    private const string _localhostDevice = "Localhost";
    private const int _jobIdLength = 5;
    private bool _creatingNewJob;
    private bool _shouldViewJob;
    private bool _runNow;
    private bool _canSaveJob;
    private string _headerTitle;

    protected override void OnInitialized()
    {
        _allowedFileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
            {
                { DevicePlatform.WinUI, new[] { ".ps1" } },
                { DevicePlatform.macOS, new[] { "ps1" } }
            }
        );
        _filePickOptions = new PickOptions()
        {
            // PickerTitle is used by macOS but not Windows - unreliable for providing information to user
            PickerTitle = "Please select a PowerShell script file",
            FileTypes = _allowedFileTypes,
        };

        InitJob();

        PowerShellService.OutputChanged += (object sender, List<ScriptOutputMessage> newOutput) =>
        {
            InvokeAsync(() => this.StateHasChanged());
        };
    }

    private void InitJob()
    {
        if (Id == null)
        {
            _creatingNewJob = true;
            _job = ScriptJobService.NewJob(new PowerShellScript(PowerShellService), _localhostDevice);
            Id = _job.Id;
            _headerTitle = "New Job";
        }
        else
        {
            _job = ScriptJobService.GetJobOrDefault((int)Id);
            _headerTitle = $"Edit Job {Id}";
        }
    }

    private void OnDateChanged(DateTime newDate, TimeSpan time, ScriptParameter parameter)
    {
        parameter.Value = newDate.Date.Add(time);
    }

    private TimeSpan OnTimeChanged(TimeSpan newTime, DateTime date, ScriptParameter parameter)
    {
        parameter.Value = date.Date.Add(newTime);

        return newTime;
    }

    private async void PickAndLoadScript()
    {
        FileResult fileResult = await FilePickerHandler.PickFile(_filePickOptions);

        if (fileResult != null)
        {
            _job.Script.LoadFromFile(fileResult.FullPath);

            this.StateHasChanged();
        }
    }

    private void EditScript()
    {
        if (!_job.Script.IsLoaded()) return;

        FileHandler.OpenFileWithDefaultProgram(_job.Script.FilePath);
    }

    private void RefreshScript()
    {
        if (_job.Script.Refresh())
        {
            this.StateHasChanged();
        }
    }

    private void RemoveScript()
    {
        _job.Script.Unload();

        this.StateHasChanged();
    }

    private void GoToJobs()
    {
        NavigationManager.NavigateTo("/jobs");
    }

    private void TrySaveJob()
    {
        _jobForm.Validate();

        if (_canSaveJob)
        {
            if (_creatingNewJob)
            {
                ScriptJobService.RegisterJob(_job);
            }
            NavigationManager.NavigateTo(_shouldViewJob ? $"job-results/{_job.Id}" : "/jobs");
        }
    }
}
