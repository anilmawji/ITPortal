@page "/jobs"

@using Microsoft.AspNetCore.Authorization;

@implements IDisposable

@inject IScriptJobService ScriptJobService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

@*@attribute [Authorize]*@

<PageContainer Title="PowerShell Jobs">
    <style>
        /* Correct MudTable border */
        .mud-table {
            border-radius: 8px;
            border: solid 1px #D2D2D2;
        }

        /* Correct MudTable height and color */
        .mud-table-toolbar {
            --mud-internal-toolbar-height: 48px !important;
        }
    </style>

    <div class="table-container">
        <MudTable T="ScriptJob" Items="@ScriptJobService.Jobs.Values" Dense="true" Hover="true" FixedHeader="true" Filter="new Func<ScriptJob, bool>(FilterJobFunc)"
                  Height="calc(100% - 90px - 10px);">
            <ToolBarContent>
                <MudTextField @bind-Value="_searchString" Placeholder="@($"Search {ScriptJobService.Jobs.Values.Count} items...")" Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                    <MudTh Style="padding-left: 30px">
                        <MudTableSortLabel SortBy="new Func<ScriptJob, object>(x=>x.Name)">Name</MudTableSortLabel>
                    </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ScriptJob, object>(x=>x.Script.FileName)">Script</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ScriptJob, object>(x=>x.State)">Status</MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<ScriptJob, object>(x=>x.Description)">Description</MudTableSortLabel>
                </MudTh>
                <MudTh Style="text-align:right; margin-right: 50px">
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Style="color:white" @onclick="GoToNewJob">
                        <MudText>New Job</MudText>
                    </MudButton>
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTh DataLabel="Name" Style="padding-left: 30px">@context.Name</MudTh>
                <MudTh DataLabel="script">@context.Script.FileName</MudTh>
                <MudTh DataLabel="status">
                    <ChipText Color="@(context.State.GetColor())" Text="@context.State.ToString()" />
                </MudTh>
                <MudTh DataLabel="Description">@context.Description.NormalizeLength(40)</MudTh>
                <MudTh Style="text-align:right">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" aria-label="edit" Style="margin-right: 10px"
                                   OnClick="() => GoToEditJob(context.Name)"></MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" aria-label="delete"
                                   OnClick="() => OpenDeleteJobDialog(context.Name)"></MudIconButton>
                </MudTh>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="@_pageSizeOptions" />
            </PagerContent>
        </MudTable>
    </div>
</PageContainer>

@code {
    private static readonly DialogOptions _dialogOptions = new() {
        CloseButton = true,
        DisableBackdropClick = true,
        MaxWidth = MaxWidth.ExtraSmall
    };
    private static readonly DialogParameters<Dialog> _deleteJobDialogParameters = new();
    private static readonly int[] _pageSizeOptions = { 10, 20, 30 };

    private string _searchString = "";

    protected override void OnInitialized()
    {
        foreach (ScriptJob job in ScriptJobService.Jobs.Values)
        {
            job.OnStateChanged += (object sender, ScriptJobState newState) =>
            {
                InvokeAsync(() => this.StateHasChanged());
            };
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _deleteJobDialogParameters.Add(dialog => dialog.ContentText, "Are you sure you want to delete this script job? This action cannot be undone.");
            _deleteJobDialogParameters.Add(dialog => dialog.SubmitButtonText, "Delete");
            _deleteJobDialogParameters.Add(dialog => dialog.Color, Color.Error);
        }
    }

    private void GoToNewJob()
    {
        NavigationManager.NavigateTo("/create-job");
    }

    private void GoToEditJob(string jobName)
    {
        NavigationManager.NavigateTo($"create-job/{jobName}");
    }

    private async void OpenDeleteJobDialog(string jobName)
    {
        IDialogReference dialog = DialogService.Show<Dialog>("Confirm Job Deletion", _deleteJobDialogParameters, _dialogOptions);
        DialogResult result = await dialog.Result;

        if (!result.Canceled)
        {
            ScriptJobService.Jobs.Remove(jobName);
            this.StateHasChanged();
        }
    }

    private bool FilterJobFunc(ScriptJob job) => DoFilterJobFunc(job, _searchString);

    private bool DoFilterJobFunc(ScriptJob job, string searchString)
    {
        return string.IsNullOrWhiteSpace(searchString)
                    || job.Name.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase)
                    || job.Script.FileName.Contains(searchString, StringComparison.OrdinalIgnoreCase)
                    || job.State.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase)
                    || job.Description.Contains(searchString, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        foreach (ScriptJob job in ScriptJobService.Jobs.Values)
        {
            job.DisposeOnStateChangedEventSubscriptions();
        }
    }
}
